<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Recording</title>
  <style>
    .LiveIntention1v1 {
      color: black;
    }
  </style>
</head>
<body>
  <div class="LiveIntention1v1">
    <video id="video" autoplay muted playsinline webkit-playsinline="true" style="width: 400px; object-fit: cover; transform: rotateY(180deg);"></video>
    <button id="startRecordBtn">开始录制</button>
    <button id="stopRecordBtn">结束录制</button>
    <button id="reloadBtn">页面刷新</button>
  </div>
  <div><textarea id="consoleView" style="width: 100%; height: 10000px;"></textarea></div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const video = document.getElementById('video');
      const startRecordBtn = document.getElementById('startRecordBtn');
      const stopRecordBtn = document.getElementById('stopRecordBtn');
      const reloadBtn = document.getElementById('reloadBtn');
      const consoleView = document.getElementById('consoleView');

      let localStream = null;
      let mediaRecorder = null;
      const videoBitsPerSecond = 500000;
      const mimeType = ['video/mp4'];
      let transcoding = true;

      async function getVideoStream() {
        try {
          let audioConstraints = {};
          const sampleRateSupported = navigator.mediaDevices.getSupportedConstraints().sampleRate;
          const sampleSizeSupported = navigator.mediaDevices.getSupportedConstraints().sampleSize;
          if (sampleRateSupported) {
            audioConstraints = Object.assign(audioConstraints, { sampleRate: 16000 });
          }
          if (sampleSizeSupported) {
            audioConstraints = Object.assign(audioConstraints, { sampleSize: 16 });
          }
          if (!sampleRateSupported && !sampleSizeSupported) {
            audioConstraints = true;
          }

          const constraints = {
            audio: audioConstraints,
            video: {
              width: 480,
              height: 640,
              facingMode: 'user',
              frameRate: 400,
              bitrate: 200
            },
          };

          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          onStreamSuccess(stream);
        } catch (error) {
          consoleView.append('error' + JSON.stringify(error.message) + '\n');
          console.log('error', error);
        }
      }

      function onStreamSuccess(stream) {
        localStream = stream;
        if ('srcObject' in video) {
          video.srcObject = stream;
        } else {
          video.src = window.URL.createObjectURL(stream);
        }
        video.play();
      }

      function startRecord() {
        try {
          let mediaOptions = {
            videoBitsPerSecond: videoBitsPerSecond
          };

          for (const type of mimeType) {
            const canRecord = MediaRecorder.isTypeSupported(type);
            if (canRecord) {
              mediaOptions.mimeType = type;
              transcoding = false;
              break;
            }
          }

          consoleView.append(JSON.stringify(mediaOptions) + '\n');
          mediaRecorder = new MediaRecorder(new MediaStream([localStream.getVideoTracks()[0]]), mediaOptions);
          handleMediaRecorder(mediaRecorder, 'videoChunk');
        } catch (error) {
          consoleView.append('startRecord error' + JSON.stringify(error.message) + '\n');
          console.log('startRecord error', error);
        }
      }

      function handleMediaRecorder(recorder, type) {
        recorder.addEventListener('dataavailable', (event) => {
          consoleView.append(`${Date.now()}` + `${type} dataavailable  ${event.data}` + '\n');
          console.log(`${Date.now()}`, `${type} dataavailable  ${event.data}`);
        });

        recorder.start(1000);

        recorder.addEventListener('error', (event) => {
          consoleView.append(`${Date.now()}` + `${type} error:${event.error.name}` + '\n');
          console.log(`${Date.now()}`, `${type} error:${event.error.name}`);
        });
        recorder.addEventListener("start", (event) => {
          consoleView.append(`${Date.now()}` + `${type} start` + '\n');
          console.log(`${Date.now()}`, `${type} start`);
        });
        recorder.addEventListener('stop', (event) => {
          consoleView.append(`${Date.now()}` + `${type} stop` + '\n');
          console.log(`${Date.now()}`, `${type} stop`);
        });
        recorder.addEventListener("pause", (event) => {
          consoleView.append(`${Date.now()}` + `${type} paused` + '\n');
          console.log(`${Date.now()}`, `${type} paused`);
        });
        recorder.addEventListener("resume", (event) => {
          consoleView.append(`${Date.now()}`+ `${type} resumed` + '\n');
          console.log(`${Date.now()}`, `${type} resumed`);
        });
      }

      function stopRecord() {
        if (mediaRecorder && mediaRecorder.state != 'inactive') {
          removeRecorderListener(mediaRecorder);
          mediaRecorder.stop();
        }
        video.pause();
      }

      function removeRecorderListener(recorder) {
        recorder.removeEventListener('dataavailable', handleRecorderDataAvailable);
        recorder.removeEventListener('start', handleRecorderStart);
        recorder.removeEventListener('error', handleRecorderError);
        recorder.removeEventListener('stop', handleRecorderStop);
        recorder.removeEventListener("pause", handleRecorderPause);
        recorder.removeEventListener("resume", handleRecorderResume);
      }

      function handleRecorderDataAvailable(event) {
        consoleView.append(`${Date.now()}` + `dataavailable  ${event.data}` + '\n');
        console.log(`${Date.now()}`, `dataavailable  ${event.data}`);
      }

      function handleRecorderStart(event) {
        consoleView.append(`${Date.now()}` + `start` + '\n');
        console.log(`${Date.now()}`, `start`);
      }

      function handleRecorderError(event) {
        consoleView.append(`${Date.now()}` + `error:${event.error.name}` + '\n');
        console.log(`${Date.now()}`, `error:${event.error.name}`);
      }

      function handleRecorderStop(event) {
        consoleView.append(`${Date.now()}` + `stop` + '\n');
        console.log(`${Date.now()}`, `stop`);
      }

      function handleRecorderPause(event) {
        consoleView.append(`${Date.now()}` + `paused` + '\n');
        console.log(`${Date.now()}`, `paused`);
      }

      function handleRecorderResume(event) {
        consoleView.append(`${Date.now()}` + `resumed` + '\n');
        console.log(`${Date.now()}`, `resumed`);
      }

      function stopGetUserMedia() {
        if (localStream) {
          localStream.getTracks().forEach((track) => {
            track.stop();
          });
        }
        if (video) {
          video.srcObject = null;
        }
      }

      startRecordBtn.addEventListener('click', startRecord);
      stopRecordBtn.addEventListener('click', stopRecord);
      reloadBtn.addEventListener('click', function() {
        location.reload();
      });

      window.addEventListener('beforeunload', function() {
        stopGetUserMedia();
      });

      getVideoStream();
    });
  </script>
</body>
</html>